{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/article_detail.css' %}">

<div class="container mt-5">
    <div class="card shadow">
        {% if object.photo %}
        <img src="{{ object.photo.url }}" class="card-img-top" alt="{{ object.title }}">
        {% endif %}
        <div class="card-body">
            <h2 class="card-title">{{ object.title }}</h2>
            <p class="card-text text-muted">Yozilgan sana: {{ object.date|date:"d M Y, H:i" }}</p>
            <p class="card-text">{{ object.body|linebreaks | safe }}</p>
            <p class="text-end"><strong>Muallif:</strong> {{ object.author.username }}</p>

            <!-- Like / Dislike -->
            <div class="interaction-box mt-4">
                <div class="d-flex flex-wrap gap-3 justify-content-start">

                    <form id="like-form" method="post" action="{% url 'like_article' object.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-success {% if user_liked %}active{% endif %}">
                            ğŸ‘ Layk
                        </button>
                    </form>

                    <form id="dislike-form" method="post" action="{% url 'dislike_article' object.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger {% if user_disliked %}active{% endif %}">
                            ğŸ‘ Dizlayk
                        </button>
                    </form>
                </div>

                <!-- Like/Dislike Koâ€˜rsatkichlar -->
                <div class="reaction-counts mt-2 d-flex gap-3">
                    <span id="like-count" class="badge bg-success">ğŸ‘ {{ like_count }}</span>
                    <span id="dislike-count" class="badge bg-danger">ğŸ‘ {{ dislike_count }}</span>
                </div>
            </div>

            <!-- Comment form -->
            <div class="mt-4">
                {% if user.is_authenticated %}
                <form method="post">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit" class="btn btn-primary">âœ Kommentariya yozish</button>
                </form>
                {% else %}
                <p class="text-muted">Kommentariya yozish uchun tizimga kiring.</p>
                {% endif %}
            </div>

            <!-- Action buttons -->
            <div class="action-buttons d-flex gap-2 mt-4">
                <a href="{% url next %}" class="btn btn-outline-secondary">â† Orqaga</a>
                {% if request.user == object.author %}
                <a href="{% url 'article_delete' object.pk %}" class="btn btn-danger">ğŸ—‘ Oâ€˜chirish</a>
                <a href="{% url 'article_update' object.pk %}" class="btn btn-primary">âœ Tahrirlash</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Kommentariyalar -->
    <div class="comments-section mt-5">
        <h4>ğŸ’¬ Kommentariyalar ({{ total_comments }})</h4>
        {% if comments %}
        <ul class="list-group mb-3" id="comment-list">
            {% for comment in comments %}
            <li class="list-group-item">
                <div class="comment-author">{{ comment.author.username }}</div>
                <small class="text-muted">{{ comment.created_at|date:"d M Y, H:i" }}</small>
                <p class="mb-1">{{ comment.content }}</p>
            </li>
            {% endfor %}
        </ul>

        {% if total_comments > 5 %}
        <div class="text-center">
            <button id="load-more" class="btn btn-outline-info" data-page="2">Koâ€˜proq koâ€˜rsatish</button>
        </div>
        {% endif %}
        {% else %}
        <p class="text-muted">Hozircha hech qanday kommentariya yoâ€˜q.</p>
        {% endif %}
    </div>
</div>

<!-- Like/Dislike JS -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    function handleVote(formId) {
        const form = document.getElementById(formId);
        form?.addEventListener('submit', function (e) {
            e.preventDefault();
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Accept': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('like-count').innerText = 'ğŸ‘ ' + data.likes;
                document.getElementById('dislike-count').innerText = 'ğŸ‘ ' + data.dislikes;

                const likeBtn = document.querySelector('#like-form button');
                const dislikeBtn = document.querySelector('#dislike-form button');

                likeBtn.classList.toggle('active', data.user_liked);
                dislikeBtn.classList.toggle('active', data.user_disliked);
            });
        });
    }

    handleVote('like-form');
    handleVote('dislike-form');
});
</script>

<!-- Load more comments -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const loadMoreBtn = document.getElementById('load-more');
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function () {
            const page = this.dataset.page;
            fetch("{% url 'load_more_comments' object.pk %}?page=" + page)
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('comment-list');
                    data.comments.forEach(comment => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.innerHTML = `<div class="comment-author">${comment.author}</div>
                                        <small class="text-muted">${comment.created_at}</small>
                                        <p class="mb-1">${comment.content}</p>`;
                        list.appendChild(li);
                    });

                    if (data.has_next) {
                        loadMoreBtn.dataset.page = parseInt(page) + 1;
                    } else {
                        loadMoreBtn.remove();
                    }
                });
        });
    }
});
</script>

{% endblock %}
